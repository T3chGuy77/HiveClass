montageDefine("6e7bb6e","extensions/common/js/services/focus",{dependencies:[],factory:function(){var e="fullscreen",n={state:e},t={state:"maximized"},o={focused:!0},i={populate:!0},r={populate:!1};define(["bluebird"],function(s){var u=function(){this._resourceUrl=null,this._window=null,this._started=!1,this._locked=!1,this._resizeInterval=null;var u=this;this._lockRemoval=function(e){u._window&&u._window.id==e&&u._unlockEverything().then(function(){u._openResource(!0)})},this._ensureTabWithIdExists=function(e){return new s(function(n,t){chrome.tabs.query({},function(o){var i=o.filter(function(n){return n.id===e});1==i.length?n(i[0]):t()})})},this._ensureFocusWindowExists=function(){return new s(function(e,n){u._window?chrome.windows.getAll(r,function(t){var o=t.filter(function(e){return e.id===u._window.id});1==o.length?e(o[0]):n()}):n()})},this._lockFocus=function(e){setTimeout(function(){u._window&&u._window.id!=e&&u._ensureFocusWindowExists().then(function(e){chrome.windows.update(e.id,o)},function(){})},0)},this._lockUpdate=function(e,n){n.url&&n.url.split("#")[0]!=u._resourceUrl.split("#")[0]?chrome.tabs.update(e,{url:u._resourceUrl}):n.url&&(u._resourceUrl=n.url)},this._lockNewTab=function(e){u._ensureTabWithIdExists(e.id).then(function(e){chrome.tabs.remove(e.id)},function(){})},this._lockNewWindow=function(e){chrome.windows.remove(e.id)},this._lockResize=function(){u._unlockResize(),u._resizeInterval=setInterval(function(){u._ensureFocusWindowExists().then(function(t){u._locked&&t.state!=e&&chrome.windows.update(t.id,n)},function(){})},100)},this._unlockResize=function(){u._resizeInterval&&(clearInterval(u._resizeInterval),u._resizeInterval=null)},this._ensureEventHasListener=function(e,n){e.hasListener(n)||e.addListener(n)},this._ensureEventHasNotListener=function(e,n){e.hasListener(n)&&e.removeListener(n)},this._lockEverything=function(){return new s(function(e){u._ensureEventHasListener(chrome.windows.onFocusChanged,u._lockFocus),u._ensureEventHasListener(chrome.windows.onRemoved,u._lockRemoval),u._ensureEventHasListener(chrome.windows.onCreated,u._lockNewWindow),u._ensureEventHasListener(chrome.tabs.onUpdated,u._lockUpdate),u._ensureEventHasListener(chrome.tabs.onCreated,u._lockNewTab),u._lockResize(),u._locked=!0,e()})},this._unlockEverything=function(){return new s(function(e){u._ensureEventHasNotListener(chrome.windows.onFocusChanged,u._lockFocus),u._ensureEventHasNotListener(chrome.windows.onRemoved,u._lockRemoval),u._ensureEventHasNotListener(chrome.windows.onCreated,u._lockNewWindow),u._ensureEventHasNotListener(chrome.tabs.onUpdated,u._lockUpdate),u._ensureEventHasNotListener(chrome.tabs.onCreated,u._lockNewTab),u._unlockResize(),u._locked=!1,e()})},this._openInExistingWindow=function(){return new s(function(e){chrome.windows.get(u._window.id,i,function(n){n?u._unlockEverything().then(function(){chrome.tabs.update(n.tabs[0].id,{url:u._resourceUrl},function(){u._lockEverything(n).then(function(){e()})})}):u._openResource().then(function(){e()})})})},this._openInNewWindow=function(){return new s(function(e){chrome.windows.create({url:u._resourceUrl,focused:!0},function(t){chrome.windows.update(t.id,n,function(n){u._window=n,u._lockEverything(n).then(function(){e()})})})})},this._openResource=function(e){return!e&&u._window?this._openInExistingWindow():this._openInNewWindow()},this.start=function(){this._openResource().then(function(){u._started=!0})},this.stop=function(){this._unlockEverything().then(function(){u._started=!1,chrome.windows.update(u._window.id,t),u._window=null})},this.isStarted=function(){return this._started},this.setResource=function(e){this._resourceUrl=e,this._started&&this._openResource()}};return u})}});
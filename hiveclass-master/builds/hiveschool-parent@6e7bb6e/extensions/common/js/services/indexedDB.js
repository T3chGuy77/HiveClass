define(["bluebird"],function(e){var n="readwrite",t="readonly",o=function(e){this.version=1,this._name=e,this.repositories={}};o.prototype=Object.create(Object.prototype,{_init:{value:function(){var n=this;return new e(function(e){var t=indexedDB.open(n._name,n.version);t.onsuccess=function(){n._openingDb=null,n.db=t.result,e(n)},t.onerror=function(){n._openingDb=null,"VersionError"===t.error.name&&(n.version++,n._init().then(function(){e(n)}))}})}},addObjectStores:{value:function(n){var t=this;return this._init().then(function(){return new e(function(e){if(0!=n.filter(function(e){return t.db.objectStoreNames.contains(e.name)}).length){for(var o=0;n.length>o;o++){var i=n[o];t.repositories[i.name]=new r(t.db,i.name)}e(t.repositories)}else{t.db.close(),t.version++;var s=indexedDB.open(t._name,t.version);s.onupgradeneeded=function(){for(var e=event.target.result,t=0;n.length>t;t++){var o,r=n[t];if(e.objectStoreNames.contains(r.name)){var i=event.target.transaction;o=i.objectStore(r.name)}else o=e.createObjectStore(r.name,{keyPath:r.keyPath});o.indexNames.contains(r.keyPath)||o.createIndex(r.keyPath,r.keyPath,{unique:!0})}},s.onsuccess=function(){t.db=s.result;for(var o=0;n.length>o;o++){var i=n[o];t.repositories[i.name]=new r(t.db,i.name)}e(t.repositories)},s.onerror=function(){"VersionError"===s.error.name&&(t.version++,t._init())}}})})}}});var r=function(e,n){this.db=e,this.objectStoreName=n};return r.prototype=Object.create(Object.prototype,{create:{value:function(t){var o=this;return new e(function(e,r){var i=o.db.transaction([o.objectStoreName],n),s=i.objectStore(o.objectStoreName),c=s.add(t);c.onsuccess=function(){e(c.result)},c.onerror=function(e){r(e)}})}},get:{value:function(n){var o=this;return new e(function(e,r){var i=o.db.transaction([o.objectStoreName],t),s=i.objectStore(o.objectStoreName),c=s.get(n);c.onsuccess=function(){e(c.result)},c.onerror=function(e){r(e)}})}},update:{value:function(t){var o=this;return new e(function(e,r){var i=o.db.transaction([o.objectStoreName],n),s=i.objectStore(o.objectStoreName),c=s.put(t);c.onsuccess=function(){e(c.result)},c.onerror=function(e){r(e)}})}},"delete":{value:function(t){var o=this;return new e(function(e,r){var i=o.db.transaction([o.objectStoreName],n),s=i.objectStore(o.objectStoreName),c=s.delete(t);c.onsuccess=function(){e(c.result)},c.onerror=function(e){r(e)}})}},dump:{value:function(){var n=this;return new e(function(e,o){var r=n.db.transaction([n.objectStoreName],t),i=r.objectStore(n.objectStoreName),s=i.openCursor(),c=[];s.onsuccess=function(){var n=s.result;n?(c.push(n.value),n.continue()):e(c)},s.onerror=function(e){o(e)}})}},count:{value:function(){var n=this;return new e(function(e,o){var r=n.db.transaction([n.objectStoreName],t),i=r.objectStore(n.objectStoreName),s=i.index(i.keyPath).count();s.onsuccess=function(){e(s.result)},s.onerror=function(e){o(e)}})}}}),o});